<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ANTI-CACHE: Forzar al navegador a siempre buscar la versión más nueva -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Permissions-Policy"
        content="autoplay=*, encrypted-media=*, accelerometer=*, gyroscope=*, picture-in-picture=*, clipboard-write=*, web-share=*">
    <title>UnderLess (Beta)</title>
    <link rel="icon" href="underless.ico">
    <style>
        @font-face {
            font-family: 'UnderLessFont';
            src: url('fonts/UnderLess_font.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }

        @font-face {
            font-family: 'OtherTextFont';
            src: url('fonts/other_text.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'ChillFont';
            src: url('fonts/chill_font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'PoppinsFont';
            src: url('fonts/Poppins-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg: #161819;
            --panel: #242829;
            --muted: #b3b3b3;
            --accent: #55b725;
            --bar-bg: #27282a;
            --white: #ffffff;
            --bar-active: #ffffff;
            --grisesito: #575757;

            --modal-win: var(--accent);
            --modal-lose: #b42828;
            --modal-title-win: #ffffff;
            --modal-title-lose: #ffffff;
            --modal-bg-header: #962020;
            --modal-bg-body: #212425;

            /* NUEVO COLOR PARA SKIP (GRIS OSCURO) */
            --skip-color: #313536;

            /* NUEVOS COLORES PARA RACHA */
            --streak-zero: var(--muted);
            --streak-low: #ec9a00;
            --streak-medium: #ff6600;
            --streak-high: #ff0000;
        }

        html,
        body {
            height: 100%;
            margin: 0
        }

        body {
            background-color: var(--bg);
            color: var(--white);
            font-family: 'OtherTextFont', sans-serif;
            /* CAMBIO: Fuente local para todo el body */
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: flex-start;




        }





        #ui-root {
            width: 900px;
            /* tu tamaño base */
            height: 950px;
            /* altura base */
            transform-origin: top center;
        }


        /* CAMBIO EN HEADER PARA CENTRAR EL LOGO Y EL EMOTE VERTICALMENTE */
        header {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 25px 10px 10px 25px;
            box-sizing: border-box;
            max-width: 900px;
            position: relative;
            z-index: 50;
        }

        header .logo {
            font-family: 'UnderLessFont', sans-serif;
            /* CAMBIO: Fuente local para el logo */
            font-size: 3.8em;
            font-weight: 800;
            letter-spacing: -1px;
            cursor: default;
            text-transform: none;
            /* CAMBIO: No uppercase para permitir U mayúscula y resto minúscula */
            --colorunder: #0082c4;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;

        }

        /* ESTILO PARA EL EMOTE */
        #emote-7tv {
            width: 170px;
            height: 50px;
            margin-top: 3px;
            display: block;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            padding: 0 20px 50px 20px;
            box-sizing: border-box;
            margin-top: 40px;
            position: relative;
        }


        .guess-boxes {
            width: 100%;
            margin-bottom: 50px;
            max-width: 550px;
        }

        .guess-box {

            background-color: var(--bg);
            /* fondo igual al body */
            border: 2px solid var(--panel);
            /* borde del color de acento */
            border-radius: 4px;
            padding: 13px 18px;
            /* reducido el padding para compensar el borde de 2px */
            margin-bottom: 8px;
            color: var(--muted);
            height: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
            /* transición para el cambio de color */
        }

        /* ESTADO POR DEFECTO: CASILLA VACÍA */
        .guess-box:empty {
            background-color: var(--bg);
            border: 2px solid var(--panel);
        }

        /* ESTADO: CASILLA LLENA (ANTES DE SER JUZGADA) */
        .guess-box:not(:empty):not(.correct):not(.incorrect):not(.skipped):not(.partial) {
            background-color: var(--panel);
            /* color de panel por si hay texto temporal */
            border-color: var(--panel);
        }

        /* ANIMACIÓN POP GLOBAL */
        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            70% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .guess-box.skipped,
        .guess-box.incorrect,
        .guess-box.correct,
        .guess-box.partial {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            /* Pop effect */
            border: none;
        }

        .guess-box.correct {
            background-color: var(--accent);
            /* Verde */
            color: white;
            animation: none;
            border-color: var(--accent);
            /* relleno completo */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .guess-box.incorrect {
            background-color: #ff3333;
            /* Rojo */
            border-color: #cc0000;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .guess-box.partial {
            background-color: #e9ab00;
            /* Amarillo */
            border-color: #e6c200;
            color: #ffffff;
            /* Texto negro para contraste */
        }

        /* NUEVO ESTADO PARA SKIP */
        .guess-box.skipped {
            background-color: var(--skip-color);
            /* Gris oscuro */
            color: white;
            border-color: var(--skip-color);
            /* relleno completo */
        }



        /* Barra de Progreso */
        .progress-bar-container {
            width: 100%;
            max-width: 900px;
            height: 25px;
            background-color: var(--bar-bg);
            border-radius: 0;
            position: relative;
            margin-bottom: 40px;
            overflow: visible;
        }

        .progress-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--bar-active);
            width: 0%;
            /* REMOVED: transition causes lag on mobile - now using requestAnimationFrame */
            z-index: 1;
        }

        .segments-overlay {
            position: relative;
            display: flex;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .progress-segment {
            position: relative;
            height: 100%;
        }

        .progress-segment:last-child {
            border-right: none;
        }

        .segment-divider {
            position: absolute;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: var(--bg);
            z-index: 3;
            transform: translateX(-50%);
        }

        /* Marcador de tiempo (flecha estática) */
        .timer-text {
            position: absolute;
            top: -35px;
            left: 0%;
            transform: translateX(-50%);
            font-size: 0.9em;
            color: var(--white);
            white-space: nowrap;
            font-weight: bold;
            transition: none;
            z-index: 10;
        }

        .timer-text::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -8px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid var(--white);
        }

        /* Boton de Play/Pause */
        button.play-button {
            background-color: var(--accent);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            margin-top: 10px;
            margin-bottom: 40px;
            opacity: 1;
            border: none;
        }

        button.play-button[disabled] {
            opacity: 0.5;
            cursor: default;
        }

        button.play-button:not([disabled]):active {
            /* REMOVED ANIMATION */
            transform: none;
        }

        button.play-button svg {
            fill: white;
            width: 28px;
            height: 28px;
            margin-left: 2px
        }

        /* Controles de Busqueda */
        .search-controls-container {
            width: 100%;
            max-width: 900px;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .controls-row {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: center;
            gap: 10px;
        }

        .search-container {
            display: flex;
            flex-grow: 1;
            max-width: 600px;
            background-color: var(--panel);
            border-radius: 4px;
            opacity: 1;
            transition: opacity 0.3s;
            /* overflow: hidden; REMOVED to allow songs-list to show outside/above */
            position: relative;
            /* Ensure absolute child positions are relative to this */
            align-items: center;
            /* Ensure icon is centered vertically */
        }

        .search-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .search-container svg {
            fill: var(--muted);
            margin-left: 12px;
            width: 18px;
            height: 18px;
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 15px;
            /* REDUCIDO: de 18px a 12px */
            background: transparent;
            border: none;
            color: white;
            font-size: 1.0em;
            /* REDUCIDO: de 1.1em a 1.0em */
            outline: none;
        }


        .search-input::placeholder {
            color: var(--muted)
        }

        /* Botón Skip */
        #skip-button-standalone {
            background-color: var(--white);
            color: var(--panel);
            border: none;
            padding: 12px 25px;
            font-size: 1.0em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            font-weight: bold;
        }


        #skip-button-standalone:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        #skip-button-standalone:disabled {
            cursor: default;
            opacity: 0.5;
        }

        /* NUEVO: Modo "Mandale" (Submit) */
        #skip-button-standalone.submit-mode {
            background-color: var(--accent);
            /* Verde */
            color: white;
        }

        #skip-button-standalone.submit-mode:hover {
            background-color: #4a9e20;
            /* Verde más oscuro */
        }

        #audio-player {
            display: none
        }

        /* Lista de Sugerencias */
        #songs-list {
            position: absolute;
            background-color: var(--panel);
            border-radius: 4px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            /* Ancho exacto del contenedor padre */
            max-width: none;
            /* Quitar max-width heredado */
            top: auto;
            bottom: 100%;
            /* Pegado al borde superior del input */
            margin-bottom: 5px;
            /* Pequeño espacio */
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            transform-origin: bottom;
        }

        #songs-list.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #ffffff;
            font-size: 1em;
            text-align: left
        }

        .suggestion-item:hover {
            background-color: #333333
        }

        .suggestion-item {
            font-family: 'ChillFont', sans-serif;
        }

        #game-over-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #game-over-message.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .game-over-content {
            background-color: var(--modal-bg-body);
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
            display: flex;
            flex-direction: column;

        }

        .game-over-header {
            padding: 20px 30px;
            /* Padding del header */
            background-color: var(--modal-bg-header);
            /* Fondo rojo/verde del header */
            color: var(--white);
            text-align: center;
        }

        .game-over-body {
            padding: 30px;
            /* Padding del cuerpo principal */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Estilos de título */
        #game-result {
            font-size: 2.2em;
            font-weight: 600;
            text-transform: uppercase;
            margin: 0;
        }

        /* Color dinámico para el header */
        .game-over-content.win .game-over-header {
            background-color: var(--modal-win);
            /* Verde */
            color: var(--modal-title-win);
        }

        .game-over-content.lose .game-over-header {
            background-color: var(--modal-lose);
            /* Rojo */
            color: var(--modal-title-lose);
        }

        /* Estilo de la respuesta */
        #correct-answer-container {
            font-size: 1.1em;
            color: var(--white);
            /* Texto principal blanco */
            margin: 0;
            text-align: center;
        }

        #correct-answer-container .label {
            font-size: 0.8em;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        #correct-answer {
            font-size: 1.1em;
            font-weight: bold;
            display: block;
        }


        /* Botones del pop-up */
        .action-button {
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 0px;
            /* Para icon + text */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .play-again-button {
            background-color: var(--accent);
            color: white;
            margin-top: 10px;
        }

        .play-again-button:hover {
            background-color: #4a9e20;
        }

        /* Ajuste de hover para contraste en estado WIN (verde) */


        /* NUEVOS ESTILOS PARA REPRODUCTOR COMPLETO */
        .full-player-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 0 5px 0;
            border-top: 1px solid #444;
            /* Separador visual más claro */
            margin-top: 10px;
        }

        /* CAMBIO: Centrar botón y apilar tiempo debajo */
        .full-player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            /* Espacio entre el botón y el tiempo */
        }

        .mini-play-button {
            width: 35px;
            height: 35px;
            min-width: 35px;
            min-height: 35px;
            padding: 0;
            border-radius: 50%;
            background-color: var(--grisesito);
            box-shadow: none;
            border: none;
            cursor: pointer;
        }

        .mini-play-button svg {
            width: 18px;
            height: 18px;
            fill: white;
            margin-left: 2px;
        }

        .mini-play-button:active {
            transform: scale(0.95);
        }


        /* Slider de Búsqueda (Seeker) */
        #full-song-seeker {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bar-bg);
            border-radius: 999px;
            outline: none;
            cursor: pointer;
        }

        #full-song-seeker::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--grisesito);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            cursor: pointer;
        }

        #full-song-seeker::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--grisesito);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            cursor: pointer;
        }


        /* volumen style */
        .volume-container {
            position: fixed;
            top: 20px;
            right: 30px;
            width: 160px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            justify-content: flex-end;
            padding: 0;
            z-index: 100;
        }

        .volume-icon {
            width: 18px;
            height: 18px;
            opacity: 0.9;
            fill: #bfbfbf
        }

        input[type=range].volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 120px;
            height: 4px;
            background: var(--bar-bg);
            border-radius: 999px;
            outline: none;
        }

        input[type=range].volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type=range].volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type=range].volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type=range].volume-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        .reset-button {
            position: absolute;
            top: 25px;
            left: 30px;
            background: linear-gradient(135deg, #424242 0%, #3b3b3b 100%);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #424242 0%, #3b3b3b 100%);
        }

        .reset-button:active {
            transform: translateY(0);
        }


        .game-over-content.lose .play-again-button {
            background-color: var(--modal-lose);
            /* Utiliza el rojo de perder */
        }

        .game-over-content.lose .play-again-button:hover {
            background-color: #570600;
            /* Rojo más oscuro para hover/interacción */
        }


        /* responsive */
        @media (max-width:850px) {
            body {
                zoom: 1;
                overflow-y: auto;
            }

            .guess-boxes {
                max-width: 90%;
            }

            .progress-bar-container {
                max-width: 90%;
            }

            .search-controls-container {
                max-width: 90%;
            }

            .search-container {
                max-width: calc(90% - 70px);
            }

            #songs-list {
                max-width: calc(90% - 70px);
            }

            .volume-container {
                display: none;
            }

            .reset-button {
                left: 10px;
            }

            header {
                padding-right: 10px;
                padding-left: 10px;
            }

            .game-over-content {
                padding: 0;
            }

            /* Eliminado padding */

        }

        /* === MOBILE PHONE SPECIFIC === */
        @media (max-width: 480px) {
            body {
                overflow-x: hidden;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
                min-height: 100dvh;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 10px;
            }

            #ui-root {
                width: 100%;
                height: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            header {
                padding: 5px 15px;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            header .logo {
                font-size: 2.8em;
                margin-bottom: 3px;
            }

            #emote-7tv {
                width: 130px;
                height: auto;
                margin-top: 0;
            }

            .mode-selector {
                margin-top: 10px;
                margin-bottom: 5px;
                padding: 4px;
                gap: 6px;
            }

            .mode-button {
                padding: 8px 16px;
                font-size: 0.95em;
            }

            main {
                margin-top: 15px;
                /* More spacing from header */
                padding: 0 15px 25px 15px;
                /* More horizontal padding */
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* Artist section - CENTERED */
            #artist-section {
                margin-bottom: 18px;
                /* More space below */
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                /* Force center */
            }

            .artist-search-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                /* Center the search container */
            }

            .artist-search-container .search-container {
                width: 100%;
                /* Full width */
                max-width: 100%;
            }

            #current-artist-display {
                font-size: 1.1em;
                margin-bottom: 10px;
                text-align: center;
                width: 100%;
            }

            /* Guess boxes */
            .guess-boxes {
                margin-bottom: 18px;
                /* More space */
                width: 100%;
                max-width: 100%;
            }

            .guess-box {
                padding: 12px 14px;
                margin-bottom: 6px;
                height: auto;
                min-height: 20px;
                font-size: 1em;
            }

            /* Progress bar */
            .progress-bar-container {
                width: 100%;
                height: 22px;
                margin-bottom: 15px;
                /* More space */
            }

            .timer-text {
                font-size: 0.85em;
                top: -26px;
            }

            /* Racha */
            #streak {
                font-size: 1.15em;
                margin-top: 8px;
                margin-bottom: 10px;
                /* More space */
            }

            /* Play button */
            button.play-button {
                width: 60px;
                /* Bigger */
                height: 60px;
                margin-top: 10px;
                margin-bottom: 25px;
                /* More space below */
            }

            button.play-button svg {
                width: 26px;
                height: 26px;
            }

            /* Search controls - LARGER */
            .search-controls-container {
                width: 100%;
                gap: 8px;
                margin-top: 5px;
            }

            .controls-row {
                width: 100%;
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: center;
                /* Center the row */
            }

            .search-container {
                flex: 1;
                min-width: 0;
                height: 55px;
                /* Bigger search bar */
            }

            .search-input {
                padding: 12px 16px;
                font-size: 1.05em;
                height: 100%;
                box-sizing: border-box;
                width: 100%;
            }

            #skip-button-standalone {
                padding: 0 20px;
                font-size: 1.05em;
                height: 55px;
                /* Match search bar */
                white-space: nowrap;
                flex-shrink: 0;
            }

            #songs-list {
                width: 100%;
                max-width: none;
                max-height: 200px;
            }

            .suggestion-item {
                padding: 12px 16px;
                font-size: 1em;
            }

            /* Streaks & Lives UI */
            #streak-saver-ui {
                font-size: 0.95em;
                padding: 8px 12px;
                margin-top: 15px;
                /* More space */
            }

            #streak-saver-ui img {
                width: 18px;
                height: 18px;
            }

            /* Reset button */
            .reset-button {
                top: 8px;
                left: 8px;
                padding: 6px 12px;
                font-size: 0.8em;
            }

            /* Game Over Modal */
            .game-over-content {
                width: 92%;
                max-width: 400px;
            }

            .game-over-header {
                padding: 15px 20px;
            }

            #game-result {
                font-size: 1.8em;
            }

            .game-over-body {
                padding: 20px;
                gap: 15px;
            }

            .action-button {
                padding: 14px 24px;
                font-size: 1.05em;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            header .logo {
                font-size: 2.4em;
            }

            #emote-7tv {
                width: 110px;
                height: 32px;
            }

            .guess-box {
                padding: 8px 12px;
                margin-bottom: 4px;
                height: 10px;
                font-size: 0.9em;
            }

            .progress-bar-container {
                height: 18px;
            }

            button.play-button {
                width: 45px;
                height: 45px;
            }

            #streak {
                font-size: 1em;
            }
        }

        /* NUEVO ESTILO PARA RACHA */
        #streak {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            color: var(--accent);
            user-select: none;
            pointer-events: none;
        }

        /* === NUEVO SISTEMA DE COLORES PARA RACHA (reemplaza el anterior) === */
        :root {
            /* Racha 1-10: de verde a rojo */
            --streak-1: #55b725;
            /* verde original */
            --streak-5: #ffd000;
            --streak-10: #ff3300;
            /* rojo fuerte */

            /* Racha 11-20: rojo cada vez más oscuro/intenso */
            --streak-15: #cc0000;
            --streak-20: #990000;

            /* Racha 21-25: violeta suave → violeta medio */
            --streak-21: #b14aed;
            --streak-25: #9c3be0;

            /* Racha 26+: violeta intenso */
            --streak-max: #8a2be2;

            /* Racha 170+: celeste piola */
            --streak-cyan: #00d4ff;
        }

        #streak {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            color: var(--streak-1);
            /* color por defecto */
            transition: color 0.5s ease;
            /* animación suave al cambiar racha */
        }

        /* NUEVO: Estilo para etiqueta de creador */
        #creator-tag {
            font-size: 0.8em;
            color: var(--muted);
            text-align: center;
            margin: 0;
            padding: 0;
        }

        /* NUEVO: Estilo para streak-saver-ui */
        #streak-saver-ui {
            font-size: 1.0em;
            color: var(--white);
            text-align: center;
            margin-top: 10px;
            padding: 5px;
            background-color: var(--panel);
            border-radius: 4px;
            width: auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        #streak-saver-ui img {
            width: 20px;
            height: 20px;
            /* Forzar altura igual al ancho */
            object-fit: contain;
            margin-left: 0;
            /* Quitar margen extra si usamos gap */
            vertical-align: middle;
        }

        /* === ESTILOS PARA EL SELECTOR DE MODO === */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            background: var(--panel);
            padding: 5px;
            border-radius: 8px;
        }

        .mode-button {
            background: transparent;
            border: none;
            color: var(--muted);
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: 'OtherTextFont', sans-serif;
        }

        .mode-button:hover {
            color: var(--white);
        }

        .mode-button.active {
            background: var(--accent);
            color: var(--white);
        }

        /* === ESTILOS PARA LA SECCIÓN DE ARTISTA === */
        #artist-section {
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #artist-section.show {
            display: flex;
        }

        .artist-search-container {
            width: 100%;
            position: relative;
        }

        #current-artist-display {
            font-size: 1.2em;
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }

        #artist-list {
            position: absolute;
            background-color: var(--panel);
            border-radius: 4px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            top: 100%;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        #artist-list.show {
            display: block;
        }

        /* TIPOGRAFÍA POPPINS PARA ELEMENTOS ESPECÍFICOS */
        .play-again-button,
        #skip-button-standalone,
        #search-input,
        #artist-search-input,
        .suggestion-item {
            font-family: 'PoppinsFont', sans-serif !important;
        }

        #search-input::placeholder,
        #artist-search-input::placeholder {
            font-family: 'PoppinsFont', sans-serif !important;
            opacity: 0.8;
            /* Asegurar legibilidad */
        }

        /* ESTILOS POPUP RACHA */
        .streak-popup {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--panel);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            /* box-shadow removed for solid look */
            z-index: 2000;
            max-width: 250px;
            font-family: 'PoppinsFont', sans-serif;
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .popup-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--white);
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .popup-text {
            font-size: 0.85em;
            color: var(--muted);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .claim-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-family: 'PoppinsFont', sans-serif;
            transition: background-color 0.2s;
        }

        .claim-button:hover {
            background-color: #4a9e20;
        }

        .close-popup {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .close-popup:hover {
            color: var(--white);
        }

        /* MODAL INFO VIDAS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: var(--panel);
            border: 2px solid var(--grisesito);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            position: relative;
            font-family: 'PoppinsFont', sans-serif;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: popIn 0.3s ease-out;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--white);
            margin-bottom: 15px;
        }

        .modal-content p {
            color: var(--muted);
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .life-milestones {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        .life-milestones li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 6px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .milestone-badge {
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 30px;
            text-align: center;
            font-size: 0.9em;
        }

        .milestone-hearts {
            display: flex;
            gap: 5px;
        }

        .milestone-hearts img {
            width: 22px;
            height: 22px;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.8em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: var(--white);
        }
    </style>
</head>


<header>
    <div class="logo">UnderLess</div>
    <img id="emote-7tv" src="img/peepo-band.gif" alt="peepo band">

    <!-- MODE SELECTOR -->
    <div class="mode-selector">
        <button id="mode-normal" class="mode-button active" onclick="switchMode('normal')">Normal</button>
        <button id="mode-artist" class="mode-button" onclick="switchMode('artist')">Artista</button>
    </div>
</header>

<div id="ui-root">
</div>

<!-- Volume controls removed -->

<!-- YOUTUBE BUTTON -->
<div class="youtube-container">
    <button class="bugs-btn" onclick="openBugsModal()">Bugs</button>
    <a href="https://www.youtube.com/@UnderLesss" target="_blank" rel="noopener noreferrer" class="youtube-btn"
        aria-label="YouTube Channel">
        <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
            <path
                d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
        </svg>
    </a>
</div>

<style>
    .youtube-container {
        position: fixed;
        top: 50px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
    }

    .youtube-btn {
        width: 35px;
        height: 35px;
        background: #ff0000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        text-decoration: none;
    }

    .youtube-btn:hover {
        transform: scale(1.1);
        background: #cc0000;
    }

    .youtube-container .tooltip {
        visibility: hidden;
        width: max-content;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 5px 10px;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 5px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
        pointer-events: none;
        white-space: nowrap;
    }

    .youtube-container:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
        .youtube-container {
            right: 15px;
            top: 55px;
            align-items: center;
        }

        .youtube-container .tooltip {
            right: auto;
            left: 50%;
            transform: translateX(-50%);
        }
    }

    /* LOADER ANIMATION */
    .loader {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #ffffff;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* BUGS BUTTON & MODAL */
    .bugs-btn {
        background-color: #444;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        font-family: 'PoppinsFont', sans-serif;
        font-size: 0.8rem;
        cursor: pointer;
        margin-right: 10px;
        transition: background-color 0.2s;
    }

    .bugs-btn:hover {
        background-color: #666;
    }

    .bugs-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 4000;
        backdrop-filter: blur(2px);
    }

    .bugs-modal-content {
        background-color: var(--panel);
        border: 2px solid var(--grisesito);
        border-radius: 15px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        position: relative;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    .bugs-modal-content p {
        color: #eee;
        line-height: 1.6;
        margin-bottom: 10px;
    }

    .bugs-modal-content a {
        color: #1da1f2;
        /* Twitter blue */
        text-decoration: none;
        font-weight: bold;
    }

    .bugs-modal-content a:hover {
        text-decoration: underline;
    }
</style>

<!-- BUGS MODAL HTML -->
<div id="bugs-modal" class="bugs-modal-overlay">
    <div class="bugs-modal-content">
        <h2>Reportar Bugs</h2>
        <p>Si encontraste un bug o tenés una sugerencia, contactame en Twitter:</p>
        <p><a href="https://x.com/maxterpola/status/1865611843477164103" target="_blank">Post de Reporte de Bugs</a></p>
        <button class="close-modal" onclick="closeBugsModal()">×</button>
    </div>
</div>

<!-- LIBRARIES -->
<script src="data.js"></script>

<script>
    // =====================================================
    // UI LOGIC (Updated)
    // =====================================================

    function selectArtist(artist) {
        selectedArtist = artist;
        const display = document.getElementById('current-artist-display');
        if (display) {
            display.innerHTML = `<span style="color: #ffffff;">Artista:</span> <span style="color: #55b725;">${artist}</span>`;
        }
        const artistSearchInput = document.getElementById('artist-search-input');
        if (artistSearchInput) artistSearchInput.value = '';

        const artistListEl = document.getElementById('artist-list');
        if (artistListEl) artistListEl.classList.remove('show');

        availableSongs = [];
        resetGame(true);
        saveModeState('artist');
    }

    // BUGS MODAL FUNCTIONS
    function openBugsModal() {
        const modal = document.getElementById('bugs-modal');
        if (modal) modal.style.display = 'flex';
        playSound('click');
    }

    function closeBugsModal() {
        const modal = document.getElementById('bugs-modal');
        if (modal) modal.style.display = 'none';
        playSound('click');
    }

    // Close bugs modal on outside click
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('bugs-modal');
        if (e.target === modal) {
            closeBugsModal();
        }
    });

    // Event Listeners para búsqueda de artista
    // Helper para renderizar la lista de artistas
    function renderArtistSuggestions(list) {
        artistListEl.innerHTML = '';
        if (list && list.length > 0) {
            list.forEach(artist => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = artist;
                div.onclick = () => selectArtist(artist);
                artistListEl.appendChild(div);
            });
            artistListEl.classList.add('show');
        } else {
            artistListEl.classList.remove('show');
        }
    }

    // Event Listeners para búsqueda de artista
    artistSearchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        // Si hay texto, filtra. Si está vacío, muestra todos.
        const matches = query ? filterArtists(query) : artistList;
        renderArtistSuggestions(matches);
    });

    // Mostrar todos al hacer click (focus)
    artistSearchInput.addEventListener('click', () => {
        const query = artistSearchInput.value;
        const matches = query ? filterArtists(query) : artistList;
        renderArtistSuggestions(matches);
    });


    document.addEventListener('click', (e) => {
        if (!artistSearchInput.contains(e.target) && !artistListEl.contains(e.target)) {
            artistListEl.classList.remove('show');
        }
    });

    // -----------------------------------------------------
    // game / audio logic
    async function resetGame(forceNew = false) {
        isGameOver = false;
        pauseAudioInternal();
        isFullSongPlaying = false;

        // nuevo: limpiar el intervalo del reproductor completo
        if (fullPlayerInterval) clearInterval(fullPlayerInterval);
        fullPlayerInterval = null;
        if (fullSongSeeker) fullSongSeeker.value = 0;
        if (fullSongTime) fullSongTime.textContent = '0:00 / 0:00';
        audioPlayer.onloadedmetadata = null; // limpiar listeners
        audioPlayer.onended = null;
        if (fullSongIconPlay) updateFullPlayerIcon(false);

        isSnippetPlaying = false;
        snippetRemainingMs = 0;
        snippetDurationMs = 0;

        // Si se fuerza un juego nuevo (botón reset/play again), borramos la canción guardada
        if (forceNew) {
            playSound('click');
            localStorage.removeItem('savedSong');
        }

        // availableSongs se rellena dentro de selectRandomSong si está vacío
        selectRandomSong();

        guessCount = 0;
        hasGuessedCorrectly = false;
        searchInput.value = "";
        songsList.classList.remove('show');
        gameOverMessage.classList.remove('show');

        // DELAYED: Clean up colors (so they don't flash during fade out)
        setTimeout(() => {
            gameOverContent.classList.remove('win', 'lose');
        }, 300);

        // Si no hay canción seleccionada (modo artista sin artista), deshabilitar búsqueda
        if (!currentSong.archivo) {
            document.getElementById('search-container').classList.add('disabled');
        } else {
            document.getElementById('search-container').classList.remove('disabled');
        }

        playButton.setAttribute('disabled', '');
        // Disable skip while loading
        skipButton.disabled = true;
        // Show loader
        playButton.innerHTML = '<div class="loader"></div>';

        clearGuessBoxes();


        gameStartTime = 0;

        updateTimeMarker(0);
        if (progressBarFill) progressBarFill.style.width = '0%';
        // updatePlayIcon(false); // REMOVED: This was overwriting the loader immediately!


        if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = null;
        }

        if (currentSong.archivo) {
            // FIX: Encode URL to handle spaces and special chars on GitHub Pages
            const encodedPath = encodeURI(currentSong.archivo);

            if (window.location.protocol !== 'file:') {
                try {
                    const response = await fetch(encodedPath);
                    const blob = await response.blob();
                    currentBlobUrl = URL.createObjectURL(blob);
                    audioPlayer.src = currentBlobUrl;
                } catch (e) {
                    console.error("Error loading audio blob:", e);
                    audioPlayer.src = encodedPath; // Fallback
                }
            } else {
                // Local file: use direct path
                audioPlayer.src = currentSong.archivo;
            }
        } else {
            audioPlayer.src = "";
        }

        audioPlayer.currentTime = gameStartTime;

        // Configurar listener para calcular inicio aleatorio cuando tengamos la duración
        audioPlayer.onloadedmetadata = () => {
            const duration = audioPlayer.duration;
            if (isFinite(duration) && duration > 15) {
                // Random start time: from 0 to duration - 15
                gameStartTime = Math.random() * (duration - 15);
            } else {
                gameStartTime = 0;
            }
            // console.log("Random start time:", gameStartTime, "Duration:", duration);

            audioPlayer.currentTime = gameStartTime;

            saveModeState(currentMode);

            // Limpiar listener para evitar ejecuciones múltiples
            audioPlayer.onloadedmetadata = null;
        };

        audioPlayer.load(); // forzar la carga de la nueva fuente

        // corrección: usar oncanplaythrough para activar el botón solo cuando el audio está listo
        audioPlayer.oncanplaythrough = () => {
            // re-establecer currentTime con el valor aleatorio calculado
            audioPlayer.currentTime = gameStartTime;
            playButton.removeAttribute('disabled');
            // Enable skip
            skipButton.disabled = false;
            // Restore play icon
            updatePlayIcon(false);

            audioPlayer.oncanplaythrough = null; // limpiar el listener
        };

        // NUEVO: Actualizar display de racha al reset
        updateStreakDisplay();
        updateStreakSaverUI();

        // PERSISTENCIA: Guardar estado inmediatamente al iniciar nuevo juego
        saveModeState(currentMode);
    }

    // Nueva función para reseteo completo (botón REINICIAR)
    function fullReset() {
        if (currentMode === 'normal') {
            winStreak = 0;
            streaksavers = 0;
            localStorage.setItem('winStreak', winStreak);
            localStorage.setItem('streaksavers', streaksavers);
        } else {
            artistStreak = 0;
            localStorage.setItem('artistStreak', artistStreak);
        }

        // Limpiar estado guardado del juego
        localStorage.removeItem('underless_save_v1');
        normalModeState = null;
        artistModeState = null;

        // Llamar al reset normal del juego
        resetGame(true);
    }

    function cheatStreak() {
        winStreak = 37;
        localStorage.setItem('winStreak', winStreak);
        updateStreakDisplay();
        updateStreakSaverUI();
    }

    function selectRandomSong() {
        // 1. Determinar qué historial usar
        let persistentHistory = currentMode === 'normal' ? playedSongsNormal : playedSongsArtist;
        const currentLib = currentMode === 'artist' ? bibliotecaArtist : biblioteca;

        // 2. Si availableSongs está vacío, llenarlo filtrando las ya jugadas
        if (!availableSongs || availableSongs.length === 0) {
            let fullPool = [];
            if (currentMode === 'artist') {
                if (selectedArtist) {
                    fullPool = bibliotecaArtist.filter(song => extractArtist(song.nombre) === selectedArtist);
                } else {
                    fullPool = [];
                }
            } else {
                fullPool = [...biblioteca];
            }

            // Filtrar las que ya están en el historial persistente
            availableSongs = fullPool.filter(song => !persistentHistory.includes(song.nombre));

            // Si después de filtrar no queda ninguna (ya se jugaron todas), reiniciamos el historial
            if (availableSongs.length === 0 && fullPool.length > 0) {
                // Reiniciar historial
                persistentHistory = [];
                if (currentMode === 'normal') {
                    playedSongsNormal = [];
                    localStorage.setItem('playedSongsNormal', JSON.stringify([]));
                } else {
                    playedSongsArtist = [];
                    localStorage.setItem('playedSongsArtist', JSON.stringify([]));
                }
                // Volver a llenar con todas
                availableSongs = [...fullPool];
            }
        }

        // Si no hay canciones disponibles (ej. modo artista sin artista seleccionado), salir
        if (availableSongs.length === 0) {
            currentSong = {};
            return;
        }

        // 3. Elegir canción aleatoria de las disponibles
        // CORREGIDO: Math.floor, Math.random
        const randomIndexInAvailable = Math.floor(Math.random() * availableSongs.length);
        const selectedSongCandidate = availableSongs[randomIndexInAvailable];

        // 4. Actualizar canción actual
        currentSong = selectedSongCandidate;

        // 5. Sacarla de availableSongs (para esta sesión)
        availableSongs.splice(randomIndexInAvailable, 1);

        // 6. Agregar al historial persistente y guardar
        persistentHistory.push(currentSong.nombre);

        // NUEVO: Limitar historial a las últimas 20 canciones
        if (persistentHistory.length > 20) {
            persistentHistory.shift(); // Eliminar la más antigua
        }

        if (currentMode === 'normal') {
            playedSongsNormal = persistentHistory;
            localStorage.setItem('playedSongsNormal', JSON.stringify(playedSongsNormal));
        } else {
            playedSongsArtist = persistentHistory;
            localStorage.setItem('playedSongsArtist', JSON.stringify(playedSongsArtist));
        }
    }

    function clearGuessBoxes() {
        const boxes = document.querySelectorAll('.guess-box');
        boxes.forEach(box => {
            box.textContent = "";
            box.classList.remove('correct');
            box.classList.remove('incorrect');
            box.classList.remove('skipped');
            box.classList.remove('partial'); // CORRECCION: Limpiar también la clase partial (amarillo)
        });
    }

    // NUEVO: Helpers para persistencia visual
    function getGuessStates() {
        const boxes = document.querySelectorAll('.guess-box');
        return Array.from(boxes).map(box => ({
            text: box.textContent,
            classes: [...box.classList].filter(c => c !== 'guess-box')
        }));
    }

    function restoreGuessStates(guesses) {
        const boxes = document.querySelectorAll('.guess-box');
        guesses.forEach((guess, i) => {
            if (boxes[i]) {
                boxes[i].textContent = guess.text;
                guess.classes.forEach(c => boxes[i].classList.add(c));
            }
        });
    }

    // =====================================================
    // AUDIO PLAYER - Core Functions (Mobile-Optimized v2.0)
    // =====================================================

    function pauseAudioInternal(resetToIdle = true) {
        // 1. Pause the audio
        audioPlayer.pause();

        // 2. Stop animation loop
        stopAnimationLoop();

        // 3. Update state
        snippetState = resetToIdle ? 'idle' : 'paused';

        // 4. Update UI
        updatePlayIcon(false);
    }

    // nuevas funciones para reproductor completo
    function updateFullPlayerIcon(playing) {
        if (playing) {
            fullSongIconPlay.style.display = 'none';
            fullSongIconPause.style.display = 'inline-block';
        } else {
            fullSongIconPlay.style.display = 'inline-block';
            fullSongIconPause.style.display = 'none';
        }
    }

    // intervalo para actualizar el tiempo y la barra
    function startFullPlayerUpdate() {
        if (fullPlayerInterval) clearInterval(fullPlayerInterval);

        fullPlayerInterval = setInterval(() => {
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;

            if (audioPlayer.paused || audioPlayer.ended) {
                if (audioPlayer.ended) {
                    isFullSongPlaying = false;
                    updateFullPlayerIcon(false);
                    audioPlayer.currentTime = 0;
                    if (fullSongSeeker) fullSongSeeker.value = 0;
                }
                clearInterval(fullPlayerInterval);
                fullPlayerInterval = null;
                return;
            }

            if (isFinite(duration) && duration > 0 && fullSongSeeker && fullSongTime) {
                const percentage = (currentTime / duration) * 100;
                fullSongSeeker.value = percentage;
                fullSongTime.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            }
        }, 500); // actualizar dos veces por segundo
    }

    // listener para el slider de búsqueda (seeker)
    function setupFullSongSeeker() {
        if (!fullSongSeeker || fullSongSeeker.dataset.listenerSet) return;

        // al mover el slider (input), solo actualiza el tiempo en pantalla
        fullSongSeeker.addEventListener('input', function () {
            const duration = audioPlayer.duration || 0;
            const seekTo = duration * (this.value / 100);
            fullSongTime.textContent = `${formatTime(seekTo)} / ${formatTime(duration)}`;
        });

        // al soltar el slider (change), busca la posición y reproduce si estaba pausado
        fullSongSeeker.addEventListener('change', function () {
            const duration = audioPlayer.duration || 0;
            const seekTo = duration * (this.value / 100);

            if (audioPlayer.readyState >= 2) {
                audioPlayer.currentTime = seekTo;
                // si no estaba reproduciendo, iniciar la reproducción y el tracking
                if (!isFullSongPlaying && audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.warn('fallo al reproducir después de buscar:', e));
                    isFullSongPlaying = true;
                    updateFullPlayerIcon(true);
                    startFullPlayerUpdate();
                }
            }
        });

        fullSongSeeker.dataset.listenerSet = true;
    }

    // inicialización del reproductor completo cuando el modal se abre
    function initializeFullPlayer() {
        // CONTINUOUS PLAYBACK: If game over, don't stop audio, just sync UI
        if (isGameOver) {
            // NEW: Auto-resume if paused
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.warn('Auto-resume failed:', e));
            }

            isFullSongPlaying = true;
            updateFullPlayerIcon(true);
            startFullPlayerUpdate();
            setupFullSongSeeker();

            // Ensure onended is set to handle when song finishes naturally
            audioPlayer.onended = () => {
                isFullSongPlaying = false;
                updateFullPlayerIcon(false);
                audioPlayer.currentTime = 0;
                if (fullSongSeeker) fullSongSeeker.value = 0;
                if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(audioPlayer.duration)}`;
                if (fullPlayerInterval) clearInterval(fullPlayerInterval);
                fullPlayerInterval = null;
            };
            return;
        }

        // detener reproductor de snippet si aún estaba activo
        pauseAudioInternal();

        // resetear el estado del reproductor completo
        isFullSongPlaying = false;
        updateFullPlayerIcon(false);
        if (fullPlayerInterval) clearInterval(fullPlayerInterval);
        fullPlayerInterval = null;


        if (currentBlobUrl) {
            audioPlayer.src = currentBlobUrl;
        } else {
            if (window.location.protocol !== 'file:') {
                audioPlayer.src = currentSong.archivo;
            } else {
                audioPlayer.src = currentSong.archivo;
            }
        }
        audioPlayer.currentTime = 0;
        audioPlayer.load(); // forzar la carga de metadatos (duración)

        // configurar el seeker
        setupFullSongSeeker();
        if (fullSongSeeker) fullSongSeeker.value = 0;

        // esperar a que se carguen los metadatos para obtener la duración
        audioPlayer.onloadedmetadata = () => {
            const duration = audioPlayer.duration;
            if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(duration)}`;
            audioPlayer.onloadedmetadata = null; // limpiar para evitar múltiples llamadas
        };

        // configurar el evento de finalización
        audioPlayer.onended = () => {
            isFullSongPlaying = false;
            updateFullPlayerIcon(false);
            audioPlayer.currentTime = 0;
            if (fullSongSeeker) fullSongSeeker.value = 0;
            if (fullSongTime) fullSongTime.textContent = `0:00 / ${formatTime(audioPlayer.duration)}`;
            if (fullPlayerInterval) clearInterval(fullPlayerInterval);
            fullPlayerInterval = null;
        };
    }

    function toggleFullSong() {
        if (!currentSong.archivo) return;

        if (isFullSongPlaying) {
            audioPlayer.pause();
            isFullSongPlaying = false;
            updateFullPlayerIcon(false);
            if (fullPlayerInterval) clearInterval(fullPlayerInterval);
            fullPlayerInterval = null;
        } else {
            pauseAudioInternal(); // detener el snippet si estaba sonando

            // si está pausada y no en el inicio, reanudar
            if (audioPlayer.paused && audioPlayer.currentTime > 0) {
                audioPlayer.play().catch(e => console.warn('fallo al reanudar canción completa:', e));
            } else {
                // si está en el inicio (0:00) o terminó, empezar desde el principio (ya cargado por initializeFullPlayer)
                audioPlayer.currentTime = 0;
                audioPlayer.play().catch(e => console.warn('fallo al reproducir canción completa:', e));
            }

            isFullSongPlaying = true;
            updateFullPlayerIcon(true);
            startFullPlayerUpdate();
        }
    }

    /**
    * Updates the play button icon
    */
    function updatePlayIcon(playing) {
        playButton.innerHTML = playing ? iconPause : iconPlay;
        playButton.setAttribute('aria-label', playing ? 'pausar fragmento' : 'escuchar fragmento');
    }

    /**
    * Finishes snippet playback - called when target time is reached
    */
    function finishSnippet() {
        pauseAudioInternal(true);
        // Don't reset currentTime - keep position for potential resume after skip
    }


    function animationLoop() {
        // Stop if not playing
        if (snippetState !== 'playing') {
            animationFrameId = null;
            return;
        }

        const currentTime = audioPlayer.currentTime;

        // CONTINUOUS PLAYBACK: Stop checking limits if game is over
        if (isGameOver) {
            animationFrameId = null;
            return;
        }

        // Check if we've reached or passed the target time
        if (currentTime >= snippetTargetTime) {
            // Ensure bar is at exactly 100% of segment before pausing
            const targetPercentage = getPercentage(snippetTargetTime - gameStartTime);


            progressBarFill.style.width = targetPercentage + '%';

            // Stop playback
            finishSnippet();
            return;
        }

        // Update progress bar
        const elapsedFromStart = Math.max(0, currentTime - gameStartTime);
        const targetDuration = snippetTargetTime - gameStartTime;

        // FIX: Clamp elapsed time to target duration to prevent visual overshoot during frame interpolation
        const clampedElapsed = Math.min(elapsedFromStart, targetDuration);

        const percentage = getPercentage(clampedElapsed);
        progressBarFill.style.width = percentage + '%';

        // Continue the loop
        animationFrameId = requestAnimationFrame(animationLoop);
    }

    /**
    * Starts the animation loop for smooth progress updates
    */
    function startAnimationLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        animationFrameId = requestAnimationFrame(animationLoop);
    }

    /**
    * Stops the animation loop
    */
    function stopAnimationLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    /**
    * Main playback function - Mobile-Optimized v2.0
    * Uses audio events instead of timers for reliable mobile playback
    */
    function playSnippet() {
        if (hasGuessedCorrectly || playButton.hasAttribute('disabled')) return;

        const durations = getDurations();
        let targetDuration = durations[guessCount] || getTotalGameDuration();

        // "Mentira" del 0.2s: visual shows 0.1s but plays 0.2s
        if (guessCount === 0 && targetDuration === 0.1) {
            targetDuration = 0.2;
        }

        // Toggle pause if already playing
        if (snippetState === 'playing') {
            pauseAudioInternal(false); // pause, don't reset to idle
            return;
        }

        // Calculate the absolute target time in the audio
        snippetTargetTime = gameStartTime + targetDuration;

        // Determine if we should restart or resume
        const currentTime = audioPlayer.currentTime;
        const tolerance = 0.05; // 50ms tolerance

        const isShortDuration = targetDuration <= 0.5; const isPastTarget = currentTime >= snippetTargetTime - tolerance;
        const isBeforeStart = currentTime < gameStartTime - tolerance; if (isShortDuration || isPastTarget || isBeforeStart) { audioPlayer.currentTime = gameStartTime; } // Start playback audioPlayer.play() .then(()=> {
        snippetState = 'playing';
        updatePlayIcon(true);

        // Start the smooth animation loop
        startAnimationLoop();
    })
        .catch (e => {
        console.warn('Error starting playback:', e);
        snippetState = 'idle';
        updatePlayIcon(false);
    });
        }



    // función de game over modificada
    function showGameOver(won) {
        isGameOver = true;

        // inicializar el reproductor completo antes de mostrar el modal
        initializeFullPlayer();

        if (won) {
            gameResult.textContent = "ganaste gg"; // TEXTO SOLICITADO
            gameOverContent.classList.remove('win', 'lose'); // limpia ambas
            gameOverContent.classList.add('win');
            answerLabel.textContent = "la cancion era"; // etiqueta simple

            if (currentMode === 'normal') {
                winStreak++;
                localStorage.setItem('winStreak', winStreak);
                // Recompensas de Streak Save (solo en normal)
                if (winStreak === 10 || winStreak === 20 || winStreak === 40 || winStreak === 100) {
                    streaksavers++;
                    localStorage.setItem('streaksavers', streaksavers);
                }
            } else {
                artistStreak++;
                localStorage.setItem('artistStreak', artistStreak);
            }

            updateStreakDisplay();
            updateStreakSaverUI();
        } else {
            playSound('gameover');
            gameResult.textContent = "perdiste crack"; // "game over" o similar
            gameOverContent.classList.remove('win', 'lose'); // ¡limpia ambas!
            gameOverContent.classList.add('lose');
            answerLabel.textContent = "la cancion era"; // etiqueta simple

            // NUEVO: Lógica de salva rachas al perder
            if (currentMode === 'normal') {
                if (winStreak >= minstreak && streaksavers > 0) {
                    streaksavers--;
                    localStorage.setItem('streaksavers', streaksavers);
                    // Vida consumida, racha salvada.
                } else {
                    // Si no hay vidas o no llegamos al minstreak, reset fatal.
                    winStreak = 0;
                    localStorage.setItem('winStreak', winStreak);
                }
            } else {
                artistStreak = 0;
                localStorage.setItem('artistStreak', artistStreak);
            }

            updateStreakDisplay();
            updateStreakSaverUI();
        }

        correctAnswerEl.textContent = (currentSong.nombre || "");
        gameOverMessage.classList.add('show');

        document.getElementById('search-container').classList.add('disabled');
        playButton.setAttribute('disabled', '');
        skipButton.disabled = true;
    }

    function handleGuessFromSelection(selectedSongName) {
        playSound('click');
        const durations = getDurations();
        if (hasGuessedCorrectly || guessCount >= durations.length) return;

        const correctAnswer = (currentSong.nombre || "").trim();
        const guessBox = document.querySelectorAll('.guess-box')[guessCount];
        songsList.classList.remove('show');

        guessBox.classList.remove('incorrect', 'skipped');

        const isCorrect = selectedSongName.toLowerCase() === correctAnswer.toLowerCase();

        if (isCorrect) {
            guessBox.textContent = currentSong.nombre;
            guessBox.classList.add('correct');
            hasGuessedCorrectly = true;

            // CAMBIO: Deshabilitar inmediatamente y añadir el retraso de 1.5s
            document.getElementById('search-container').classList.add('disabled');
            playButton.setAttribute('disabled', '');
            skipButton.disabled = true;

            setTimeout(() => {
                showGameOver(true);
            }, 1500); // Retraso de 1.5 segundos

        } else {
            // si falla, se pone el nombre seleccionado en la casilla
            guessBox.textContent = selectedSongName || "intento fallido";

            // Lógica de coincidencia parcial (solo modo normal)
            let isPartial = false;
            if (currentMode === 'normal') {
                // Obtener string completo de artistas (antes del guion)
                const guessedArtistStr = extractArtistForGuess(selectedSongName);
                const correctArtistStr = extractArtistForGuess(correctAnswer);

                if (guessedArtistStr && correctArtistStr) {
                    // Separar por comas y limpiar espacios
                    const guessedArtists = guessedArtistStr.split(',').map(a => a.trim().toLowerCase());
                    const correctArtists = correctArtistStr.split(',').map(a => a.trim().toLowerCase());

                    // Verificar si hay ALGUNA coincidencia
                    // Si algún artista de la canción adivinada está en la lista de artistas de la correcta
                    const match = guessedArtists.some(g => correctArtists.includes(g));
                    if (match) {
                        isPartial = true;
                    }
                }
            }

            if (isPartial) {
                guessBox.classList.add('partial'); // Amarillo
            } else {
                guessBox.classList.add('incorrect'); // Rojo
            }

            guessCount++;
            if (guessCount < durations.length) { updateTimeMarker(guessCount); finishSnippet(); } else {
                showGameOver(false);
            }
        } document.getElementById('search-input').value = ""; saveModeState(currentMode); //
            Guardar estado tras intento
    } function handleSkip() {
        const durations = getDurations(); if
            (hasGuessedCorrectly || guessCount >= durations.length) return;

        // NUEVO: Si está en modo Mandale, enviar intento
        if (isSubmitMode) {
            // No reproducir sonido aquí, ya lo hace handleGuessFromSelection
            const val = searchInput.value.trim();
            if (val) {
                handleGuessFromSelection(val);
                disableSubmitMode(); // Resetear botón tras intento
            }
            return;
        }

        // SONIDO: Solo reproducir click si NO es el último skip (para que no se solape con game over)
        if (guessCount < durations.length - 1) { playSound('click'); } const
            guessBox = document.querySelectorAll('.guess-box')[guessCount]; //>>> INICIO MODIFICACIÓN JS PARA SKIP <<<
        guessBox.textContent = "Skipped"; guessBox.classList.remove('incorrect', 'correct'); // asegurar que
                    no tiene rojo ni verde guessBox.classList.add('skipped'); // nuevo: usa el gris oscuro //>>> FIN
                    MODIFICACIÓN JS PARA SKIP << < guessCount++; if (guessCount < durations.length) {
            updateTimeMarker(guessCount); // FIX: Actualizar snippetTargetTime al nuevo límite del segmento
            desbloqueado // para que el audio no se pause al llegar al límite del segmento anterior let
            newTargetDuration = durations[guessCount]; // "Mentira" del 0.2s: visual shows 0.1s but plays 0.2s
            if (guessCount === 0 && newTargetDuration === 0.1) { newTargetDuration = 0.2; }
            snippetTargetTime = gameStartTime + newTargetDuration;
        } else { showGameOver(false); }
        document.getElementById('search-input').value = ""; songsList.classList.remove('show');
        saveModeState(currentMode); // Guardar estado tras skip } // volumen if (volumeSlider) { //
        CORREGIDO: parseFloat audioPlayer.volume = parseFloat(volumeSlider.value);
        volumeSlider.addEventListener("input", e => {
            // CORREGIDO: parseFloat
            audioPlayer.volume = parseFloat(e.target.value);
        });
    }

    // fix visual: sincroniza marcador visual estatico (la flecha)
    function updateTimeMarker(index) {
        const durations = getDurations();
        // CORREGIDO: Math.min
        const safeIndex = Math.min(index, durations.length - 1);
        const targetTime = durations[safeIndex];
        const percentage = getPercentage(targetTime);

        // FIX: Ajuste visual para que la flecha no parezca adelantada en 0.1s
        // Si es el primer segmento (0.1s), le restamos un pelín
        let visualPercentage = percentage;
        if (safeIndex === 0) visualPercentage -= 0.5; // Ajuste fino

        timerTextEl.style.left = visualPercentage + '%';
        timerTextEl.textContent = formatSeconds(targetTime);

        const prevDuration = safeIndex > 0 ? durations[safeIndex - 1] : 0;

        const startPercentage = getPercentage(prevDuration);
        // FIX: Don't update progress bar fill on skip, only the arrow.
        // progressBarFill.style.width = startPercentage + '%';
    }

    // OLD TIMER-BASED FUNCTIONS REMOVED:
    // startTimeMarkerUpdate and stopTimeMarkerUpdate are replaced by
    // handleSnippetTimeUpdate and updateProgressBarVisuals using timeupdate events

    // -----------------------------------------------------
    // buscador y eventos
    // NUEVO: Variable para controlar el modo del botón Skip
    let isSubmitMode = false;

    function enableSubmitMode() {
        isSubmitMode = true;
        skipButton.textContent = "mandale";
        skipButton.classList.add('submit-mode');
    }

    function disableSubmitMode() {
        isSubmitMode = false;
        skipButton.textContent = "Skip";
        skipButton.classList.remove('submit-mode');
    }

    searchInput.addEventListener('input', function () {
        // Si el usuario escribe, desactivar modo Mandale
        disableSubmitMode();

        // no eliminar funcion de tolowercase aqui, es necesaria para la busqueda
        const query = (this.value || '').toLowerCase();
        songsList.innerHTML = '';
        if (query.length < 2) { songsList.classList.remove('show'); return; } let
            pool = currentMode === 'artist' ? bibliotecaArtist : biblioteca; if (currentMode === 'artist' &&
                selectedArtist) {
                    pool = pool.filter(s => extractArtist(s.nombre) === selectedArtist);
        }

        const filtered = pool.filter(s => s.nombre.toLowerCase().includes(query));
        if (filtered.length > 0) {
            // CORREGIDO: forEach, appendChild, slice
            filtered.forEach(song => {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                div.textContent = song.nombre;

                // EVENTO IMPORTANTE: AHORA LLAMA A LA NUEVA FUNCIÓN DE ADIVINANZA
                div.addEventListener('click', () => {
                    // primero se rellena el input con el valor seleccionado
                    searchInput.value = song.nombre;
                    songsList.classList.remove('show');

                    // CAMBIO: En lugar de adivinar directo, activar modo Mandale
                    enableSubmitMode();
                });
                songsList.appendChild(div);
            });
            songsList.classList.add('show');
        } else songsList.classList.remove('show');
    });

    document.addEventListener('click', (event) => {
        if (!event.target.closest('.search-container') && !event.target.closest('#songs-list')) {
            songsList.classList.remove('show');
        }
    });

    // CAMBIO IMPORTANTE: ESTE LISTENER FUE MODIFICADO
    searchInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            // no hace nada, bloquea el enter para forzar la selección de la lista
        }
    });

    // -----------------------------------------------------
    // init
    window.addEventListener('load', () => {
        renderGuessBoxes(); // Inicializar cajas
        renderProgressSegments();
        updateTimeMarker(0);
        if (volumeSlider) audioPlayer.volume = parseFloat(volumeSlider.value);

        // PERSISTENCIA: Cargar estado guardado
        loadFromLocalStorage();

        // Restaurar UI según el modo cargado
        if (currentMode === 'artist') {
            modeNormalBtn.classList.remove('active');
            modeArtistBtn.classList.add('active');
            artistSection.classList.add('show');
            populateArtists();
            restoreModeState('artist');
        } else {
            restoreModeState('normal');
        }

        // Cargar racha inicial (si no se cargó ya en restoreModeState -> resetGame)
        winStreak = parseInt(localStorage.getItem('winStreak')) || 0;
        updateStreakDisplay();
        updateStreakSaverUI();

        // Chequear popup de racha
        checkClaimPopup();
    });

    // LÓGICA POPUP RACHA
    function checkClaimPopup() {
        if (!localStorage.getItem('streakClaimed_v1')) {
            const popup = document.getElementById('streak-claim-popup');
            if (popup) popup.style.display = 'block';
        }
    }

    function claimStreak() {
        playSound('click');
        winStreak += 25;
        streaksavers += 2; // NUEVO: Regalar 2 vidas
        localStorage.setItem('winStreak', winStreak);
        localStorage.setItem('streaksavers', streaksavers);
        updateStreakDisplay();
        updateStreakSaverUI();

        // Marcar como reclamado
        localStorage.setItem('streakClaimed_v1', 'true');

        // Ocultar popup
        const popup = document.getElementById('streak-claim-popup');
        if (popup) popup.style.display = 'none';
    }

    function closeClaimPopup() {
        playSound('click');
        localStorage.setItem('streakClaimed_v1', 'true'); // No mostrar de nuevo
        const popup = document.getElementById('streak-claim-popup');
        if (popup) popup.style.display = 'none';
    }

    // LÓGICA MODAL INFO VIDAS
    function openLifeModal() {
        playSound('click');
        const modal = document.getElementById('life-info-modal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeLifeModal() {
        playSound('click');
        const modal = document.getElementById('life-info-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Cerrar modal al hacer click fuera del contenido
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('life-info-modal');
        if (e.target === modal) {
            closeLifeModal();
        }
    });

    window.addEventListener('beforeunload', () => {
        pauseAudioInternal();
    });


</script>
<script>
    function ajustarEscala() {
        // DISABLE ON MOBILE/TABLET
        if (window.innerWidth < 850) {
            const ui = document.getElementById("ui-root");
            if (ui) {
                ui.style.transform = '';
                ui.style.position = '';
                ui.style.left = '';
                ui.style.top = '';
            }
            return;
        }

        const baseAncho = 900;
        const baseAlto = 950;

        const escala = Math.min(
            window.innerWidth / baseAncho,
            window.innerHeight / baseAlto
        );

        // aplicar solo al contenedor interno
        const ui = document.getElementById("ui-root");
        if (ui) {
            ui.style.transform = `scale(${escala})`;
            // centrarlo
            ui.style.position = "absolute";
            ui.style.left = `50%`;
            ui.style.top = `0`;
            ui.style.transformOrigin = "top center";
            ui.style.transform = `translateX(-50%) scale(${escala})`;
        }
    }

    window.addEventListener("resize", ajustarEscala);
    window.addEventListener("load", ajustarEscala);
</script>
</body>

</html>